<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quickstart &mdash; physDBD 0.1.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="physDBD" href="modules.html" />
    <link rel="prev" title="Physics-based dynamic PCA models in TensorFlow" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> physDBD
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#import-data">Import data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-pca-parameters-network-inputs">Get PCA parameters = network inputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#differentiate-pca-parameters-network-outputs">Differentiate PCA parameters = network outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-the-network-to-be-trained">Build the network to be trained</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inputs-outputs-and-standardization">Inputs/outputs and Standardization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#train-the-network">Train the network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#analyze-the-trained-network">Analyze the trained network</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">physDBD</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">physDBD</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Quickstart</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/quickstart.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="quickstart">
<h1>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline"></a></h1>
<p>Table of contents:</p>
<ul class="simple">
<li><p><a class="reference external" href="#import-data">Import data</a></p></li>
<li><p><a class="reference external" href="#get-pca-parameters-=-network-inputs">Get PCA parameters = network inputs</a></p></li>
<li><p><a class="reference external" href="#differentiate-pca-parameters-=-network-outputs">Differentiate PCA parameters = network outputs</a></p></li>
<li><p><a class="reference external" href="#build-the-network-to-be-trained">Build the network to be trained</a></p></li>
<li><p><a class="reference external" href="#inputs/outputs-and-standardization">Inputs/outputs and Standardization</a></p></li>
<li><p><a class="reference external" href="#train-the-network">Train the network</a></p></li>
<li><p><a class="reference external" href="#analyze-the-trained-network">Analyze the trained network</a></p></li>
</ul>
<section id="import-data">
<h2>Import data<a class="headerlink" href="#import-data" title="Permalink to this headline"></a></h2>
<p>Everyting starts by importing some data. The shape of the imported array should be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">no_timepoints</span><span class="p">,</span> <span class="n">no_stoch_simulation_samples</span><span class="p">,</span> <span class="n">no_species</span><span class="p">)</span>
</pre></div>
</div>
<p>and the entries should be counts of each species.</p>
<p>If you used the Gillespie C++ library to generate data, you can use the already written convenince functions to import the data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_desc</span> <span class="o">=</span> <span class="n">DataDesc</span><span class="p">(</span>
    <span class="n">no_seeds</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
    <span class="n">time_start</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">time_end</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">time_interval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ca2i&quot;</span><span class="p">,</span><span class="s2">&quot;ip3&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">ImportHelper</span><span class="o">.</span><span class="n">import_gillespie_ssa_from_data_desc</span><span class="p">(</span>
    <span class="n">data_desc</span><span class="o">=</span><span class="n">data_desc</span><span class="p">,</span>
    <span class="n">data_dir</span><span class="o">=</span><span class="s2">&quot;...&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Note that it’s a good idea to do a standardizing transformation that transforms the data to have zero mean and unit variance, where averages are taken over both time and over stochastic simulation samples - see paper for details.</p>
</section>
<section id="get-pca-parameters-network-inputs">
<h2>Get PCA parameters = network inputs<a class="headerlink" href="#get-pca-parameters-network-inputs" title="Permalink to this headline"></a></h2>
<p>Given the data of shape:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">no_timepoints</span><span class="p">,</span> <span class="n">no_stoch_simulation_samples</span><span class="p">,</span> <span class="n">no_species</span><span class="p">)</span>
</pre></div>
</div>
<p>the PCA parameters are obtained by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create params traj and export</span>
<span class="n">muh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">varh_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">params_traj</span> <span class="o">=</span> <span class="n">ParamsTraj</span><span class="o">.</span><span class="n">fromPCA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_desc</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">muh</span><span class="p">,</span> <span class="n">varh_diag</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we are constructing the standard parameters, i.e. <code class="docutils literal notranslate"><span class="pre">muh=0</span> <span class="pre">and</span> <span class="pre">varh=I</span></code>.</p>
<p>The number of latent species in this case is <code class="docutils literal notranslate"><span class="pre">1</span></code>, and is just specified through the dimension of <code class="docutils literal notranslate"><span class="pre">muh</span></code>, which must match the dimension of <code class="docutils literal notranslate"><span class="pre">varh_diag</span></code>.</p>
<p>You can write the params to a cache for later usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Export</span>
<span class="n">params_traj</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;cache/cache_params/</span><span class="si">%s</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="n">ip3</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="Params" src="_images/params_b0.png" />
<img alt="Params" src="_images/params_wt00.png" /></p>
</section>
<section id="differentiate-pca-parameters-network-outputs">
<h2>Differentiate PCA parameters = network outputs<a class="headerlink" href="#differentiate-pca-parameters-network-outputs" title="Permalink to this headline"></a></h2>
<p>To differentiate the PCA parameters in time, different strategies can be used, but total variation regulatization (TVR) is the best at calculating derivatives of noisy signals.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alphas</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;wt00&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="s2">&quot;wt01&quot;</span><span class="p">:</span> <span class="mf">5000.0</span><span class="p">,</span>
    <span class="s2">&quot;b0&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="s2">&quot;b1&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="s2">&quot;sig2&quot;</span><span class="p">:</span> <span class="mf">5000.0</span>
<span class="p">}</span>
<span class="n">non_zero_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">alphas</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># Differentiate</span>
<span class="n">paramsTE_traj</span> <span class="o">=</span> <span class="n">params_traj</span><span class="o">.</span><span class="n">differentiate_with_TVR</span><span class="p">(</span>
    <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span> 
    <span class="n">no_opt_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
    <span class="n">non_zero_vals</span><span class="o">=</span><span class="n">non_zero_vals</span>
    <span class="p">)</span>

<span class="c1"># Export</span>
<span class="n">paramsTE_traj</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;cache/cache_deriv/</span><span class="si">%s</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="n">ip3</span><span class="p">)</span>
</pre></div>
</div>
<p>Again, we have written the parameters to a cache for convenience.</p>
<p><img alt="Derivs" src="_images/derivs_b0.png" />
<img alt="Derivs" src="_images/derivs_wt00.png" /></p>
<p>After differentiating, you should re-integrate the derivatives to use as the inputs to the network. Otherwise the training data is inconsistent!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params_traj</span><span class="o">.</span><span class="n">params_traj</span><span class="p">])</span>
<span class="n">b1_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>

<span class="c1"># Integrate</span>
<span class="n">no_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_traj</span><span class="o">.</span><span class="n">params_traj</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">params_traj_filtered</span> <span class="o">=</span> <span class="n">ParamsTraj</span><span class="o">.</span><span class="n">fromIntegrating</span><span class="p">(</span>
    <span class="n">paramsTE_traj</span><span class="o">=</span><span class="n">paramsTE_traj</span><span class="p">,</span>
    <span class="n">params_init</span><span class="o">=</span><span class="n">params_traj</span><span class="o">.</span><span class="n">params_traj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">tpt_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">no_steps</span><span class="o">=</span><span class="n">no_steps</span><span class="p">,</span>
    <span class="n">constant_vals_lf</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;sig2&quot;</span><span class="p">:</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="s2">&quot;b1&quot;</span><span class="p">:</span> <span class="n">b1_mean</span><span class="p">,</span>
        <span class="s2">&quot;wt01&quot;</span><span class="p">:</span> <span class="mf">0.00005</span>
    <span class="p">}</span>
    <span class="p">)</span>

<span class="c1"># Export</span>
<span class="n">params_traj_filtered</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;cache/cache_filtered/</span><span class="si">%s</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="n">ip3</span><span class="p">)</span>
</pre></div>
</div>
<p>You can set some of the values to be a constant here if they don’t seem to contain any relevant information (looking at the PCA parameters, some are mostly just noise).</p>
<p><img alt="Filtered" src="_images/filtered_b0.png" />
<img alt="Filtered" src="_images/filtered_wt00.png" /></p>
</section>
<section id="build-the-network-to-be-trained">
<h2>Build the network to be trained<a class="headerlink" href="#build-the-network-to-be-trained" title="Permalink to this headline"></a></h2>
<p>Now to the heart of it to build the network.</p>
<p>First specify the Fourier frequencies we intend to use to represent the latent variables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Freqs, coffs for fourier</span>
<span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">3.</span><span class="p">,</span><span class="mf">4.</span><span class="p">,</span><span class="mf">5.</span><span class="p">,</span><span class="mf">6.</span><span class="p">])</span>
<span class="n">freqs</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freqs</span> <span class="o">/</span> <span class="n">data_desc</span><span class="o">.</span><span class="n">no_times</span>
</pre></div>
</div>
<p><img alt="Freqs" src="_images/freqs_sin.png" />
<img alt="Freqs" src="_images/freqs_cos.png" /></p>
<p>Next specify the reactions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Rxns</span>
<span class="n">rxn_specs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;EAT&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;EAT&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;EAT&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;EAT&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;EAT&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;EAT&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;BIRTH&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;BIRTH&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;BIRTH&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;DEATH&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;DEATH&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;DEATH&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>Finally make the input reaction layer. This is the first layer in the network:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">muh_sin_coeffs_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">muh_cos_coeffs_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">varh_sin_coeffs_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">varh_cos_coeffs_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span><span class="mf">0.0</span><span class="p">)</span>

<span class="c1"># Reaction input layer</span>
<span class="n">rxn_lyr</span> <span class="o">=</span> <span class="n">RxnInputsLayer</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span>
    <span class="n">nv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">nh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
    <span class="n">muh_sin_coeffs_init</span><span class="o">=</span><span class="n">muh_sin_coeffs_init</span><span class="p">,</span>
    <span class="n">muh_cos_coeffs_init</span><span class="o">=</span><span class="n">muh_cos_coeffs_init</span><span class="p">,</span>
    <span class="n">varh_sin_coeffs_init</span><span class="o">=</span><span class="n">varh_sin_coeffs_init</span><span class="p">,</span>
    <span class="n">varh_cos_coeffs_init</span><span class="o">=</span><span class="n">varh_cos_coeffs_init</span><span class="p">,</span>
    <span class="n">rxn_specs</span><span class="o">=</span><span class="n">rxn_specs</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Next we will make the subnet that is the middle part of the network. This can be pretty much anything you like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subnet</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">kernel_constraint</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">max_norm</span><span class="p">(</span><span class="mf">1.</span><span class="p">)),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
<p>Put the input layer and the subnet together into a single model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">RxnModel</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span>
    <span class="n">nv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">nh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">rxn_lyr</span><span class="o">=</span><span class="n">rxn_lyr</span><span class="p">,</span>
    <span class="n">subnet</span><span class="o">=</span><span class="n">subnet</span><span class="p">,</span>
    <span class="n">non_zero_outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wt00_TE&quot;</span><span class="p">,</span><span class="s2">&quot;b0_TE&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="inputs-outputs-and-standardization">
<h2>Inputs/outputs and Standardization<a class="headerlink" href="#inputs-outputs-and-standardization" title="Permalink to this headline"></a></h2>
<p>To get the actual inputs/outputs to pass to the network:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Training data</span>
<span class="n">train_inputs0</span> <span class="o">=</span> <span class="n">params_traj</span><span class="o">.</span><span class="n">get_tf_inputs_assuming_params0</span><span class="p">()</span>
<span class="n">train_outputs0</span> <span class="o">=</span> <span class="n">paramsTE_traj</span><span class="o">.</span><span class="n">get_tf_outputs_assuming_params0</span><span class="p">(</span><span class="n">non_zero_outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wt00_TE&quot;</span><span class="p">,</span><span class="s2">&quot;b0_TE&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Again, we can specify the <code class="docutils literal notranslate"><span class="pre">non_zero_outputs</span></code> we actually want to network to predict, since some derivatives are just zero.</p>
<p>You should similarly construct some validation data.</p>
<p>We are almost ready to train the network, but we need to calculate input and output standardizations.</p>
<p>For the inputs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reaction layer to use for the normalization</span>
<span class="n">rxn_lyr_norm</span> <span class="o">=</span> <span class="n">RxnInputsLayer</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span>
    <span class="n">nv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">nh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">freqs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">freqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span>
    <span class="n">muh_sin_coeffs_init</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]),</span>
    <span class="n">muh_cos_coeffs_init</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]),</span>
    <span class="n">varh_sin_coeffs_init</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]),</span>
    <span class="n">varh_cos_coeffs_init</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]),</span>
    <span class="n">rxn_specs</span><span class="o">=</span><span class="n">rxn_specs</span>
    <span class="p">)</span>

<span class="c1"># Normalize inputs</span>
<span class="n">model</span><span class="o">.</span><span class="n">calculate_rxn_normalization</span><span class="p">(</span>
    <span class="n">rxn_lyr</span><span class="o">=</span><span class="n">rxn_lyr_norm</span><span class="p">,</span> 
    <span class="n">inputs</span><span class="o">=</span><span class="n">train_inputs</span><span class="p">,</span> 
    <span class="n">percent</span><span class="o">=</span><span class="mf">0.2</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The standardization mean and std. dev. parameters are directly stored in the <code class="docutils literal notranslate"><span class="pre">RxnModel</span></code> class.</p>
<p>For the outputs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Normalize outputs</span>

<span class="c1"># Normalization size</span>
<span class="n">percent</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">norm_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">percent</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_outputs</span><span class="p">[</span><span class="s2">&quot;wt00_TE&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating output normalization from: </span><span class="si">%d</span><span class="s2"> samples&quot;</span> <span class="o">%</span> <span class="n">norm_size</span><span class="p">)</span>

<span class="c1"># Normalize training</span>
<span class="n">train_outputs_mean</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">train_outputs_std_dev</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">train_outputs_norm</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">train_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    <span class="n">idxs_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">norm_size</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">val_subset</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">idxs_subset</span><span class="p">]</span>

    <span class="c1"># Mean, std</span>
    <span class="n">train_outputs_mean</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val_subset</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">train_outputs_std_dev</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">val_subset</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">train_outputs_mean</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="n">train_outputs_mean</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">train_outputs_std_dev</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="n">train_outputs_std_dev</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">train_outputs_norm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">train_outputs_mean</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">/</span> <span class="n">train_outputs_std_dev</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<span class="c1"># Normalize validation</span>
<span class="n">valid_outputs_norm</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">valid_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">valid_outputs_norm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">train_outputs_mean</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">/</span> <span class="n">train_outputs_std_dev</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="train-the-network">
<h2>Train the network<a class="headerlink" href="#train-the-network" title="Permalink to this headline"></a></h2>
<p>Finally we’re ready to train the model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
              <span class="n">loss</span><span class="o">=</span><span class="n">loss_fn</span><span class="p">,</span>
              <span class="n">run_eagerly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Log for the tensorboard to monitor training</span>
<span class="n">logdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">))</span>
<span class="n">tensorboard_callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">TensorBoard</span><span class="p">(</span><span class="n">logdir</span><span class="p">,</span> 
    <span class="n">histogram_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">write_graph</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

<span class="c1"># Write the weights with the best validation score</span>
<span class="c1"># Writing the entire graph here with save_weights_only=False is very slow</span>
<span class="c1"># So better to just write the weights instead</span>
<span class="n">val_checkpoint</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="s1">&#39;trained/weights_lowest_val&#39;</span><span class="p">,</span> 
    <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> 
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
    <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
    <span class="n">save_frequency</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

<span class="c1"># Train!</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_inputs</span><span class="p">,</span> 
    <span class="n">train_outputs_norm</span><span class="p">,</span> 
    <span class="n">epochs</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> 
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">valid_inputs</span><span class="p">,</span><span class="n">valid_outputs_norm</span><span class="p">),</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">tensorboard_callback</span><span class="p">,</span><span class="n">val_checkpoint</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span>
<span class="p">)</span>

<span class="c1"># Save final</span>
<span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;trained/trained_final&quot;</span><span class="p">,</span> <span class="n">save_traces</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>The training can be visualized using <code class="docutils literal notranslate"><span class="pre">tensorboard</span></code> in the usual fashion:</p>
<p><img alt="TensorBoard" src="_images/tensorboard.png" /></p>
</section>
<section id="analyze-the-trained-network">
<h2>Analyze the trained network<a class="headerlink" href="#analyze-the-trained-network" title="Permalink to this headline"></a></h2>
<p>To analyze the trained network, you direclty use the <code class="docutils literal notranslate"><span class="pre">integrate</span></code> method of the <code class="docutils literal notranslate"><span class="pre">RxnModel</span></code> class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">params_traj_int</span> <span class="o">=</span> <span class="n">model_trained</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span>
    <span class="n">params_start</span><span class="o">=</span><span class="n">params_start</span><span class="p">,</span>
    <span class="n">tpt_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">no_steps</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
    <span class="n">time_interval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">output_mean</span><span class="o">=</span><span class="n">train_outputs_mean</span><span class="p">,</span>
    <span class="n">output_std_dev</span><span class="o">=</span><span class="n">train_outputs_std_dev</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The learned trajectories (may) look like this:</p>
<p><img alt="Integrated" src="_images/integrated_b0.png" />
<img alt="Integrated" src="_images/integrated_wt00.png" /></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Physics-based dynamic PCA models in TensorFlow" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="modules.html" class="btn btn-neutral float-right" title="physDBD" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Oliver K. Ernst.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>